name: Pull Request Checks

on:
  pull_request:
    branches: [ main, dev, staging ]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  pr-checks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linter
      id: lint
      run: npm run lint
      continue-on-error: true

    - name: Build project
      id: build
      run: npm run build
      continue-on-error: true

    - name: Comment PR
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          // Only run on pull requests
          if (context.eventName !== 'pull_request') {
            console.log('Not a pull request event, skipping comment');
            return;
          }

          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('Build Status')
          );
          
          // Check step outcomes
          const lintStatus = '${{ steps.lint.outcome }}';
          const buildStatus = '${{ steps.build.outcome }}';
          
          const allPassed = lintStatus === 'success' && buildStatus === 'success';
          const status = allPassed ? '✅ Passed' : '❌ Failed';
          
          let statusDetails = '';
          if (!allPassed) {
            statusDetails = '\n**Failed Steps:**\n';
            if (lintStatus !== 'success') statusDetails += '- Linter failed\n';
            if (buildStatus !== 'success') statusDetails += '- Build failed\n';
          }
          
          const body = `## Build Status: ${status}
          
          **Commit:** \`${context.sha.substring(0, 7)}\`
          **Branch:** \`${context.payload.pull_request.head.ref}\`${statusDetails}
          
          ${allPassed ? 
            'All checks passed! This PR is ready for review.' : 
            'Some checks failed. Please fix the issues before merging.'
          }`;
          
          try {
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
          } catch (error) {
            console.error('Failed to post comment:', error);
          }
